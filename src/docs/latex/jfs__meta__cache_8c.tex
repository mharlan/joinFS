\hypertarget{jfs__meta__cache_8c}{
\section{jfs\_\-meta\_\-cache.c File Reference}
\label{jfs__meta__cache_8c}\index{jfs\_\-meta\_\-cache.c@{jfs\_\-meta\_\-cache.c}}
}
{\ttfamily \#include \char`\"{}jfs\_\-meta\_\-cache.h\char`\"{}}\par
{\ttfamily \#include \char`\"{}sglib.h\char`\"{}}\par
{\ttfamily \#include $<$errno.h$>$}\par
{\ttfamily \#include $<$stdlib.h$>$}\par
{\ttfamily \#include $<$stdio.h$>$}\par
{\ttfamily \#include $<$string.h$>$}\par
{\ttfamily \#include $<$sys/types.h$>$}\par
{\ttfamily \#include $<$attr/xattr.h$>$}\par
{\ttfamily \#include $<$pthread.h$>$}\par
\subsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structjfs__meta__cache}{jfs\_\-meta\_\-cache}
\end{DoxyCompactItemize}
\subsection*{Defines}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{jfs__meta__cache_8c_a36fa39f5771a47165d75d270495aa552}{JFS\_\-META\_\-CACHE\_\-SIZE}~10000
\item 
\#define \hyperlink{jfs__meta__cache_8c_abc40e53d50a7a43fd97525ace6d07dd6}{JFS\_\-META\_\-CACHE\_\-T\_\-CMP}(e1, e2)~(!((strcmp(e1-\/$>$path, e2-\/$>$path) == 0) \&\& ((e1-\/$>$keyid -\/ e2-\/$>$keyid) == 0)))
\end{DoxyCompactItemize}
\subsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
typedef struct \hyperlink{structjfs__meta__cache}{jfs\_\-meta\_\-cache} \hyperlink{jfs__meta__cache_8c_a523f4c600f3413c005ef34de54704a73}{jfs\_\-meta\_\-cache\_\-t}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{jfs__meta__cache_8c_a76b79ab52fb73fb07dc8a5a9d797be12}{SGLIB\_\-DEFINE\_\-HASHED\_\-CONTAINER\_\-PROTOTYPES} (SGLIB\_\-DEFINE\_\-HASHED\_\-CONTAINER\_\-FUNCTIONS(\hyperlink{structjfs__meta__cache}{jfs\_\-meta\_\-cache\_\-t}, SGLIB\_\-DEFINE\_\-HASHED\_\-CONTAINER\_\-FUNCTIONS(JFS\_\-META\_\-CACHE\_\-SIZE, jfs\_\-meta\_\-cache\_\-t\_\-hash)
\item 
void \hyperlink{jfs__meta__cache_8c_a0305c6e77e35d9ef171ffd9930032f86}{jfs\_\-meta\_\-cache\_\-destroy} ()
\item 
int \hyperlink{jfs__meta__cache_8c_a790d61eb3f110066c1cebdaec9abc462}{jfs\_\-meta\_\-cache\_\-get\_\-value} (const char $\ast$path, int keyid, char $\ast$$\ast$value)
\item 
int \hyperlink{jfs__meta__cache_8c_abc475b4d78ea3d1223d663e30391c5c6}{jfs\_\-meta\_\-cache\_\-add} (const char $\ast$path, int keyid, const char $\ast$value)
\item 
int \hyperlink{jfs__meta__cache_8c_ad2b30d6bdd1ad0d4cafa668ad49c5d91}{jfs\_\-meta\_\-cache\_\-remove} (const char $\ast$path, int keyid)
\end{DoxyCompactItemize}


\subsection{Define Documentation}
\hypertarget{jfs__meta__cache_8c_a36fa39f5771a47165d75d270495aa552}{
\index{jfs\_\-meta\_\-cache.c@{jfs\_\-meta\_\-cache.c}!JFS\_\-META\_\-CACHE\_\-SIZE@{JFS\_\-META\_\-CACHE\_\-SIZE}}
\index{JFS\_\-META\_\-CACHE\_\-SIZE@{JFS\_\-META\_\-CACHE\_\-SIZE}!jfs_meta_cache.c@{jfs\_\-meta\_\-cache.c}}
\subsubsection[{JFS\_\-META\_\-CACHE\_\-SIZE}]{\setlength{\rightskip}{0pt plus 5cm}\#define JFS\_\-META\_\-CACHE\_\-SIZE~10000}}
\label{jfs__meta__cache_8c_a36fa39f5771a47165d75d270495aa552}
\hypertarget{jfs__meta__cache_8c_abc40e53d50a7a43fd97525ace6d07dd6}{
\index{jfs\_\-meta\_\-cache.c@{jfs\_\-meta\_\-cache.c}!JFS\_\-META\_\-CACHE\_\-T\_\-CMP@{JFS\_\-META\_\-CACHE\_\-T\_\-CMP}}
\index{JFS\_\-META\_\-CACHE\_\-T\_\-CMP@{JFS\_\-META\_\-CACHE\_\-T\_\-CMP}!jfs_meta_cache.c@{jfs\_\-meta\_\-cache.c}}
\subsubsection[{JFS\_\-META\_\-CACHE\_\-T\_\-CMP}]{\setlength{\rightskip}{0pt plus 5cm}\#define JFS\_\-META\_\-CACHE\_\-T\_\-CMP(
\begin{DoxyParamCaption}
\item[{}]{e1, }
\item[{}]{e2}
\end{DoxyParamCaption}
)~(!((strcmp(e1-\/$>$path, e2-\/$>$path) == 0) \&\& ((e1-\/$>$keyid -\/ e2-\/$>$keyid) == 0)))}}
\label{jfs__meta__cache_8c_abc40e53d50a7a43fd97525ace6d07dd6}


\subsection{Typedef Documentation}
\hypertarget{jfs__meta__cache_8c_a523f4c600f3413c005ef34de54704a73}{
\index{jfs\_\-meta\_\-cache.c@{jfs\_\-meta\_\-cache.c}!jfs\_\-meta\_\-cache\_\-t@{jfs\_\-meta\_\-cache\_\-t}}
\index{jfs\_\-meta\_\-cache\_\-t@{jfs\_\-meta\_\-cache\_\-t}!jfs_meta_cache.c@{jfs\_\-meta\_\-cache.c}}
\subsubsection[{jfs\_\-meta\_\-cache\_\-t}]{\setlength{\rightskip}{0pt plus 5cm}typedef struct {\bf jfs\_\-meta\_\-cache} {\bf jfs\_\-meta\_\-cache\_\-t}}}
\label{jfs__meta__cache_8c_a523f4c600f3413c005ef34de54704a73}


\subsection{Function Documentation}
\hypertarget{jfs__meta__cache_8c_abc475b4d78ea3d1223d663e30391c5c6}{
\index{jfs\_\-meta\_\-cache.c@{jfs\_\-meta\_\-cache.c}!jfs\_\-meta\_\-cache\_\-add@{jfs\_\-meta\_\-cache\_\-add}}
\index{jfs\_\-meta\_\-cache\_\-add@{jfs\_\-meta\_\-cache\_\-add}!jfs_meta_cache.c@{jfs\_\-meta\_\-cache.c}}
\subsubsection[{jfs\_\-meta\_\-cache\_\-add}]{\setlength{\rightskip}{0pt plus 5cm}int jfs\_\-meta\_\-cache\_\-add (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{ path, }
\item[{int}]{ keyid, }
\item[{const char $\ast$}]{ value}
\end{DoxyParamCaption}
)}}
\label{jfs__meta__cache_8c_abc475b4d78ea3d1223d663e30391c5c6}
Add metadata to the metadata cache. 
\begin{DoxyParams}{Parameters}
\item[{\em path}]The file system path. \item[{\em keyid}]The metadata tag id. \item[{\em value}]The metadata value. \end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code or 0. 
\end{DoxyReturn}



\begin{DoxyCode}
{
  jfs_meta_cache_t *item;
  
  size_t val_len;
  size_t path_len;

  jfs_meta_cache_remove(path, keyid);

  item = malloc(sizeof(*item));
  if(!item) {
        return -ENOMEM;
  }

  path_len = strlen(path) + 1;
  item->path = malloc(sizeof(*item->path) * path_len);
  if(!item->path) {
    free(item);
    return -ENOMEM;
  }
  strncpy(item->path, path, path_len);

  val_len = strlen(value) + 1;
  item->value = malloc(sizeof(*item->value) * val_len);
  if(!item->value) {
    free(item);
    free(item->path);
    return -ENOMEM;
  }
  strncpy(item->value, value, val_len);
  item->keyid = keyid;

  pthread_rwlock_wrlock(&cache_lock);
  sglib_hashed_jfs_meta_cache_t_add(hashtable, item);
  pthread_rwlock_unlock(&cache_lock);

  return 0;
}
\end{DoxyCode}


\hypertarget{jfs__meta__cache_8c_a0305c6e77e35d9ef171ffd9930032f86}{
\index{jfs\_\-meta\_\-cache.c@{jfs\_\-meta\_\-cache.c}!jfs\_\-meta\_\-cache\_\-destroy@{jfs\_\-meta\_\-cache\_\-destroy}}
\index{jfs\_\-meta\_\-cache\_\-destroy@{jfs\_\-meta\_\-cache\_\-destroy}!jfs_meta_cache.c@{jfs\_\-meta\_\-cache.c}}
\subsubsection[{jfs\_\-meta\_\-cache\_\-destroy}]{\setlength{\rightskip}{0pt plus 5cm}void jfs\_\-meta\_\-cache\_\-destroy (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}
\label{jfs__meta__cache_8c_a0305c6e77e35d9ef171ffd9930032f86}
Destroy the \hyperlink{structjfs__meta__cache}{jfs\_\-meta\_\-cache}.

Called when joinFS gets dismount. 


\begin{DoxyCode}
{
  struct sglib_hashed_jfs_meta_cache_t_iterator it;
  jfs_meta_cache_t *item;

  pthread_rwlock_wrlock(&cache_lock);
  for(item = sglib_hashed_jfs_meta_cache_t_it_init(&it, hashtable);
      item != NULL; item = sglib_hashed_jfs_meta_cache_t_it_next(&it)) {
    free(item->path);
    free(item->value);
    free(item);
  }

  pthread_rwlock_unlock(&cache_lock);
  pthread_rwlock_destroy(&cache_lock);
}
\end{DoxyCode}


\hypertarget{jfs__meta__cache_8c_a790d61eb3f110066c1cebdaec9abc462}{
\index{jfs\_\-meta\_\-cache.c@{jfs\_\-meta\_\-cache.c}!jfs\_\-meta\_\-cache\_\-get\_\-value@{jfs\_\-meta\_\-cache\_\-get\_\-value}}
\index{jfs\_\-meta\_\-cache\_\-get\_\-value@{jfs\_\-meta\_\-cache\_\-get\_\-value}!jfs_meta_cache.c@{jfs\_\-meta\_\-cache.c}}
\subsubsection[{jfs\_\-meta\_\-cache\_\-get\_\-value}]{\setlength{\rightskip}{0pt plus 5cm}int jfs\_\-meta\_\-cache\_\-get\_\-value (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{ path, }
\item[{int}]{ keyid, }
\item[{char $\ast$$\ast$}]{ value}
\end{DoxyParamCaption}
)}}
\label{jfs__meta__cache_8c_a790d61eb3f110066c1cebdaec9abc462}
Get metadata stored in the metadata cache. 
\begin{DoxyParams}{Parameters}
\item[{\em path}]The file system path. \item[{\em keyid}]The metadata tag id. \item[{\em value}]The value returned. \end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code or 0. 
\end{DoxyReturn}



\begin{DoxyCode}
{
  jfs_meta_cache_t  check;
  jfs_meta_cache_t *result;

  char *val;

  size_t val_len;
  size_t path_len;

  check.keyid = keyid;

  path_len = strlen(path) + 1;
  check.path = malloc(sizeof(*check.path) * path_len);
  if(!check.path) {
    return -ENOMEM;
  }
  strncpy(check.path, path, path_len);

  pthread_rwlock_rdlock(&cache_lock);
  result = sglib_hashed_jfs_meta_cache_t_find_member(hashtable, &check);
  free(check.path);
  
  if(!result) {
    pthread_rwlock_unlock(&cache_lock);
    
        return -ENOATTR;
  }

  val_len = strlen(result->value) + 1;
  val = malloc(sizeof(*val) * val_len);
  if(!val) {
    free(val);
    pthread_rwlock_unlock(&cache_lock);

    return -ENOMEM;
  }
  strncpy(val, result->value, val_len);
  pthread_rwlock_unlock(&cache_lock);

  *value = val;

  return 0;
}
\end{DoxyCode}


\hypertarget{jfs__meta__cache_8c_ad2b30d6bdd1ad0d4cafa668ad49c5d91}{
\index{jfs\_\-meta\_\-cache.c@{jfs\_\-meta\_\-cache.c}!jfs\_\-meta\_\-cache\_\-remove@{jfs\_\-meta\_\-cache\_\-remove}}
\index{jfs\_\-meta\_\-cache\_\-remove@{jfs\_\-meta\_\-cache\_\-remove}!jfs_meta_cache.c@{jfs\_\-meta\_\-cache.c}}
\subsubsection[{jfs\_\-meta\_\-cache\_\-remove}]{\setlength{\rightskip}{0pt plus 5cm}int jfs\_\-meta\_\-cache\_\-remove (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{ path, }
\item[{int}]{ keyid}
\end{DoxyParamCaption}
)}}
\label{jfs__meta__cache_8c_ad2b30d6bdd1ad0d4cafa668ad49c5d91}
Remove an item the metadata cache. 
\begin{DoxyParams}{Parameters}
\item[{\em path}]The file system path. \item[{\em keyid}]The metadata tag id. \end{DoxyParams}
\begin{DoxyReturn}{Returns}
Error code or 0. 
\end{DoxyReturn}



\begin{DoxyCode}
{
  jfs_meta_cache_t check;
  jfs_meta_cache_t *elem;

  size_t path_len;

  int rc;
  
  check.keyid = keyid;

  path_len = strlen(path) + 1;
  check.path = malloc(sizeof(*check.path) * path_len);
  if(!check.path) {
    return -ENOMEM;
  }
  strncpy(check.path, path, path_len);

  pthread_rwlock_wrlock(&cache_lock);
  rc = sglib_hashed_jfs_meta_cache_t_delete_if_member(hashtable, &check, &elem);
  pthread_rwlock_unlock(&cache_lock);
  free(check.path);

  if(rc) {
    free(elem->path);
        free(elem->value);
    free(elem);
  }
  
  return 0;
}
\end{DoxyCode}


\hypertarget{jfs__meta__cache_8c_a76b79ab52fb73fb07dc8a5a9d797be12}{
\index{jfs\_\-meta\_\-cache.c@{jfs\_\-meta\_\-cache.c}!SGLIB\_\-DEFINE\_\-HASHED\_\-CONTAINER\_\-PROTOTYPES@{SGLIB\_\-DEFINE\_\-HASHED\_\-CONTAINER\_\-PROTOTYPES}}
\index{SGLIB\_\-DEFINE\_\-HASHED\_\-CONTAINER\_\-PROTOTYPES@{SGLIB\_\-DEFINE\_\-HASHED\_\-CONTAINER\_\-PROTOTYPES}!jfs_meta_cache.c@{jfs\_\-meta\_\-cache.c}}
\subsubsection[{SGLIB\_\-DEFINE\_\-HASHED\_\-CONTAINER\_\-PROTOTYPES}]{\setlength{\rightskip}{0pt plus 5cm}SGLIB\_\-DEFINE\_\-HASHED\_\-CONTAINER\_\-PROTOTYPES (
\begin{DoxyParamCaption}
\item[{SGLIB\_\-DEFINE\_\-HASHED\_\-CONTAINER\_\-FUNCTIONS(}]{ jfs\_\-meta\_\-cache\_\-t, }
\item[{SGLIB\_\-DEFINE\_\-HASHED\_\-CONTAINER\_\-FUNCTIONS(}]{ JFS\_\-META\_\-CACHE\_\-SIZE, }
\item[{jfs\_\-meta\_\-cache\_\-t\_\-hash}]{}
\end{DoxyParamCaption}
)}}
\label{jfs__meta__cache_8c_a76b79ab52fb73fb07dc8a5a9d797be12}



\begin{DoxyCode}
{
  pthread_rwlock_init(&cache_lock, NULL);
  sglib_hashed_jfs_meta_cache_t_init(hashtable);
}
\end{DoxyCode}


